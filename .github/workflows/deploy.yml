name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22.x'
    - run: cd frontend && npm ci
    - run: cd frontend && npm run build
    
    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: './frontend/dist'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    # Permissions needed for GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write

  deploy-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    # Optional: Build binary to verify compilation before deploying
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
    - run: cd backend && go test ./...
    - run: cd backend && go build -v ./...

    - name: Create firebase-key.json from secret
      run: |
        echo "${{ secrets.FIREBASE_KEY_BASE64 }}" | base64 -d > firebase-key.json

    - name: Copy files via SSH
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        source: "docker-compose.prod.yml,nginx/conf.d/prod.conf,backend/Dockerfile,backend/go.mod,backend/go.sum,backend/cmd,backend/internal,firebase-key.json"
        target: "/home/chenaho/EventManager"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          cd /home/chenaho/EventManager
          # Rename prod files to standard names for simplicity or use -f
          mv docker-compose.prod.yml docker-compose.yml
          mv nginx/conf.d/prod.conf nginx/conf.d/default.conf
          
          # Ensure firebase-key.json exists (it was copied)
          
          # Create .env for backend if needed (or pass via env vars in docker-compose)
          # For now, we assume defaults or user manually sets .env on server. 
          # But better to create a basic one.
          echo "PORT=8080" > /home/chenaho/EventManager/backend/.env
          echo "GO_ENV=production" >> /home/chenaho/EventManager/backend/.env
          echo "FIREBASE_CREDENTIALS=/home/chenaho/EventManager/firebase-key.json" >> /home/chenaho/EventManager/backend/.env
          
          docker-compose down
          docker-compose up -d --build

